<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Device Checklist & SAS Panel Parser</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <!-- Preconnect to external CDN to speed up fetching pdf.js and XLSX -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#800000">
  <style>
    /* ==============================
       Modern Professional Styling
       ============================== */
    :root {
      --primary-color: #800000; /* Rich Maroon */
      --primary-color-hover: #660000;
      --accent-color: #d62828;  /* Additional red accent if needed */
      --text-on-primary: #ffffff;
      --background-light: #f4f4f4; /* Light overall background */
      --background-white: #ffffff;
      --background-dark: #f0f0f0;
      --text-dark: #222;
      --text-medium: #444;
      --text-light: #666;
      --border-color: #e0e0e0;
      --border-radius: 6px;
      --transition-speed: 0.3s;
      --box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      --small-box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      --gradient-bg: linear-gradient(135deg, #800000, #b30000);
    }
    /* Base Styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html {
      scroll-behavior: smooth;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--background-light);
      color: var(--text-dark);
      margin-top: 80px;
      line-height: 1.6;
      padding-bottom: 60px;
    }
    h1 {
      text-align: center;
      margin: 20px 0;
      font-size: 2rem;
      color: var(--primary-color);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    p {
      color: var(--text-medium);
    }
    button {
      cursor: pointer;
      border: none;
      border-radius: var(--border-radius);
      transition: background-color var(--transition-speed), transform var(--transition-speed);
    }
    button:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }
    input, button {
      font-family: inherit;
    }
    a {
      text-decoration: none;
      color: var(--primary-color);
    }
    /* ==============================
       Fixed Top Navigation Bar
       ============================== */
    #fixedTopBar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: var(--gradient-bg);
      color: var(--text-on-primary);
      z-index: 1000;
      box-shadow: var(--box-shadow);
      padding: 10px 0;
      backdrop-filter: blur(4px);
    }
    #topBarContents {
      max-width: 900px;
      margin: auto;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
    }
    #deviceCount {
      font-weight: bold;
      font-size: 1.1em;
      margin: 5px 10px 5px 0;
      white-space: nowrap;
    }
    /* Input Styling in Top Bar */
    #searchDevices {
      flex: 1;
      min-width: 200px;
      padding: 8px 12px;
      margin: 5px 10px 5px 0;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 1rem;
      color: var(--text-dark);
      transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
      background-color: var(--background-white);
    }
    #searchDevices:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 8px rgba(128, 0, 0, 0.3);
    }
    .tripleActions {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 5px;
    }
    .hideCompletedContainer {
      display: flex;
      align-items: center;
    }
    .hideCompletedContainer label {
      margin-left: 5px;
      font-size: 0.95em;
      color: var(--text-on-primary);
    }
    .hideCompletedContainer input {
      transform: scale(1.2);
      cursor: pointer;
      accent-color: var(--text-on-primary);
    }
    #advancedToolsBtn, #undoLastBtn {
      padding: 8px 14px;
      font-size: 0.95em;
      font-weight: 500;
      background: var(--background-white);
      color: var(--primary-color);
      transition: background-color var(--transition-speed), transform var(--transition-speed);
    }
    #advancedToolsBtn:not(:disabled):hover,
    #undoLastBtn:not(:disabled):hover {
      background: #f0f0f0;
      transform: translateY(-2px);
    }
    #undoLastBtn:disabled {
      transform: none;
    }
    /* Advanced Tools Dropdown */
    #advancedToolsDropdown {
      position: absolute;
      top: calc(100% + 5px);
      right: 20px;
      background: var(--background-white);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      width: 240px;
      display: none;
      padding: 10px;
      z-index: 1001;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity var(--transition-speed), transform var(--transition-speed);
    }
    #advancedToolsDropdown.open {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
    #advancedToolsDropdown button {
      width: 100%;
      padding: 10px 12px;
      margin: 5px 0;
      background: var(--primary-color);
      color: var(--text-on-primary);
      font-size: 0.95em;
      border-radius: var(--border-radius);
      text-align: left;
      transition: background-color var(--transition-speed);
    }
    #advancedToolsDropdown button:hover {
      background: var(--primary-color-hover);
    }
    /* Header Info Section */
    #headerInfo {
      max-width: 900px;
      margin: 30px auto;
      padding: 20px;
      background: var(--background-dark);
      border-radius: var(--border-radius);
      box-shadow: var(--small-box-shadow);
      text-align: center;
      color: var(--text-medium);
      font-size: 1rem;
    }
    /* Upload Section */
    #uploadSection {
      max-width: 700px;
      margin: 30px auto;
      padding: 25px;
      background: var(--background-white);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      text-align: center;
    }
    #uploadSection p {
      margin: 10px 0;
      font-size: 1rem;
    }
    #uploadSection input[type="file"] {
      margin: 10px auto;
      font-size: 0.95em;
      color: var(--text-dark);
    }
    #uploadSection input[type="file"]::file-selector-button {
      padding: 8px 16px;
      margin-right: 10px;
      border: none;
      border-radius: var(--border-radius);
      background: var(--background-dark);
      color: var(--primary-color);
      cursor: pointer;
      transition: background-color var(--transition-speed);
    }
    #uploadSection input[type="file"]::file-selector-button:hover {
      background: #e0e0e0;
    }
    .importExportActions {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    #uploadSection button {
      padding: 10px 18px;
      background: var(--primary-color);
      color: var(--text-on-primary);
      font-size: 0.95em;
      font-weight: 500;
      transition: background-color var(--transition-speed), transform var(--transition-speed);
    }
    #uploadSection button:not(:disabled):hover {
      background: var(--primary-color-hover);
      transform: translateY(-2px);
    }
    #loading {
      margin-top: 15px;
      text-align: center;
      font-style: italic;
      color: var(--text-light);
      min-height: 1.5em;
    }
    #loading.error {
      color: var(--primary-color);
      font-weight: bold;
    }
    /* Device List Styling */
    #devicesOnPage {
      max-width: 900px;
      margin: 15px auto;
      text-align: right;
      font-size: 0.95em;
      padding: 0 15px;
      color: var(--text-medium);
    }
    #deviceList {
      max-width: 900px;
      margin: auto;
      padding: 0;
      list-style: none;
      position: relative;
      min-height: 100px;
    }
    #deviceList:empty::after {
      content: "Upload a PDF/Excel report or import a .json checklist to begin.";
      position: absolute;
      top: 20px;
      left: 0;
      width: 100%;
      text-align: center;
      color: var(--text-medium);
      font-style: italic;
      font-size: 1em;
    }
    #deviceList li {
      background: var(--background-white);
      margin: 10px 0;
      padding: 15px 20px;
      border-radius: var(--border-radius);
      display: flex;
      align-items: center;
      box-shadow: var(--small-box-shadow);
      transition: background-color var(--transition-speed), box-shadow var(--transition-speed);
      cursor: pointer;
    }
    #deviceList li:hover {
      background: #f9f9f9;
      box-shadow: var(--box-shadow);
    }
    #deviceList input[type="checkbox"] {
      margin-right: 15px;
      transform: scale(1.2);
      cursor: pointer;
      accent-color: var(--primary-color);
      flex-shrink: 0;
    }
    #deviceList label {
      flex-grow: 1;
      font-size: 0.95em;
      line-height: 1.4;
      cursor: pointer;
    }
    #deviceList label em {
      display: block;
      margin-top: 5px;
      color: var(--text-light);
      font-size: 0.9em;
    }
    #deviceList label.checked {
      text-decoration: line-through;
      color: var(--text-light);
    }
    #deviceList label.checked em {
      text-decoration: none;
    }
    #deviceList label.checked .search-highlight {
      background-color: #e9ecef;
      color: var(--text-light);
      text-decoration: line-through;
    }
    /* Last Completed Device */
    .last-completed {
      background: #fff8e1;
      color: #d35400;
      border-left: 5px solid var(--primary-color);
      margin: 10px 0;
      padding: 15px 20px;
      border-radius: var(--border-radius);
      font-weight: bold;
    }
    /* Back to Top Button */
    #backToTopBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: none;
      background: var(--primary-color);
      color: var(--text-on-primary);
      padding: 8px 12px;
      font-size: 1.2rem;
      border-radius: var(--border-radius);
      cursor: pointer;
      box-shadow: var(--box-shadow);
      transition: background-color var(--transition-speed), opacity 0.3s, transform 0.2s;
      opacity: 0.8;
    }
    #backToTopBtn:hover {
      background: var(--primary-color-hover);
      opacity: 1;
      transform: scale(1.05);
    }
    /* Responsive Design */
    @media (max-width: 600px) {
      body {
        margin-top: 70px;
      }
      #topBarContents {
        justify-content: center;
        padding: 0 10px;
      }
      #deviceCount {
        margin-bottom: 5px;
        font-size: 1.15em;
        text-align: center;
        width: 100%;
      }
      #searchDevices {
        width: 90%;
        margin: 0 auto 10px;
      }
      .tripleActions {
        width: 100%;
        justify-content: space-around;
        margin-top: 10px;
      }
      #devicesOnPage {
        text-align: center;
      }
      #advancedToolsDropdown {
        right: 50%;
        transform: translateX(50%) translateY(-10px);
        top: calc(100% + 5px);
      }
      #advancedToolsDropdown.open {
        transform: translateX(50%) translateY(0);
      }
      #uploadSection {
        margin: 20px 10px;
        padding: 20px;
      }
      #deviceList {
        margin: 0 10px 20px;
      }
      #deviceList:empty::after {
        font-size: 0.9em;
      }
    }
    /* Highlight Search Term */
    .search-highlight {
      background-color: #fff3cd;
      color: #664d03;
      border-radius: 2px;
      padding: 0 4px;
      font-weight: bold;
    }
  </style>
  <!-- Load external libraries with defer -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js" defer></script>
  <script defer>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js';
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
</head>
<body>
  <div id="fixedTopBar">
    <div id="topBarContents">
      <div id="deviceCount" aria-live="polite">Devices Remaining: 0</div>
      <input type="text" id="searchDevices" placeholder="Search devices..." aria-label="Search devices">
      <div class="tripleActions">
        <div class="hideCompletedContainer">
          <input type="checkbox" id="toggleHideCompleted" />
          <label for="toggleHideCompleted">Hide Completed</label>
        </div>
        <button id="advancedToolsBtn" aria-haspopup="true" aria-expanded="false">Advanced Tools</button>
        <button id="undoLastBtn" disabled>Undo Last</button>
      </div>
    </div>
    <div id="advancedToolsDropdown">
      <button id="markAllBtn">Mark All Completed</button>
      <button id="clearAllBtn">Clear All Unchecked</button>
      <button id="clearSessionBtn">Clear Session &amp; List</button>
    </div>
  </div>

  <h1>Device Checklist</h1>
  <div id="headerInfo"></div>

  <div id="uploadSection">
    <p>Select PDF device report(s):</p>
    <input type="file" id="pdfInput" accept="application/pdf" multiple data-button-id="pdfUploadBtn">
    <p>Select Excel device report(s):</p>
    <input type="file" id="excelInput" accept=".xlsx, .xls" multiple data-button-id="excelUploadBtn">
    <p>Import / Export Device Checklist:</p>
    <div class="importExportActions">
      <button id="exportFileBtn">Export to File</button>
      <button id="importFileBtn">Import from File</button>
    </div>
  </div>

  <div id="loading" role="status" aria-live="polite"></div>

  <div id="devicesOnPage">(Displaying: 0)</div>

  <ul id="deviceList"></ul>
  <button id="backToTopBtn" title="Scroll back to top">↑</button>

  <script defer>
    "use strict";

    // === Constants ===
    const SESSION_STORAGE_KEY = 'deviceChecklist';
    const SEARCH_DEBOUNCE_DELAY = 300; // milliseconds

    document.addEventListener('DOMContentLoaded', () => {

      // === Global State Variables ===
      let deviceChecklistData = { header: "", devices: [] };
      let undoStack = [];
      let hideCompleted = false;
      let searchDebounceTimeout = null;
      let undoCounter = 0;
      let undoCounterTimeout = null;

      // === DOM Element References ===
      const deviceCountEl = document.getElementById("deviceCount");
      const searchInputEl = document.getElementById("searchDevices");
      const toggleHideCompletedEl = document.getElementById("toggleHideCompleted");
      const advancedToolsBtnEl = document.getElementById("advancedToolsBtn");
      const undoLastBtnEl = document.getElementById("undoLastBtn");
      const advancedToolsDropdownEl = document.getElementById("advancedToolsDropdown");
      const markAllBtnEl = document.getElementById("markAllBtn");
      const clearAllBtnEl = document.getElementById("clearAllBtn");
      const clearSessionBtnEl = document.getElementById("clearSessionBtn");
      const headerInfoEl = document.getElementById("headerInfo");
      const pdfInputEl = document.getElementById("pdfInput");
      const excelInputEl = document.getElementById("excelInput");
      const exportFileBtnEl = document.getElementById("exportFileBtn");
      const importFileBtnEl = document.getElementById("importFileBtn");
      const loadingEl = document.getElementById("loading");
      const devicesOnPageEl = document.getElementById("devicesOnPage");
      const deviceListEl = document.getElementById("deviceList");
      const backToTopBtnEl = document.getElementById("backToTopBtn");
      const fileImportInputEl = document.createElement('input');
      fileImportInputEl.type = 'file';
      fileImportInputEl.accept = '.json';
      fileImportInputEl.style.display = 'none';

      // === Utility Functions ===
      function debounce(func, delay) {
          return function(...args) {
              clearTimeout(searchDebounceTimeout);
              searchDebounceTimeout = setTimeout(() => {
                  func.apply(this, args);
              }, delay);
          };
      }
      function escapeRegExp(string) {
          return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      }

      // === Session Management Functions ===
      function saveSession() {
        try {
          localStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(deviceChecklistData));
          updateUndoButtonState();
        } catch (e) {
          console.error("Error saving session:", e);
          setLoadingMessage("Could not save session. Storage might be full.", true);
        }
      }
      function loadSession() {
        const data = localStorage.getItem(SESSION_STORAGE_KEY);
        if (data) {
          try {
            deviceChecklistData = JSON.parse(data);
            if (!deviceChecklistData.header) deviceChecklistData.header = "";
            if (!Array.isArray(deviceChecklistData.devices)) deviceChecklistData.devices = [];
            deviceChecklistData.devices = deviceChecklistData.devices.map(d => ({ ...d, checked: d.checked || false }));
            return true;
          } catch (e) {
            console.error("Error parsing session data:", e);
            localStorage.removeItem(SESSION_STORAGE_KEY);
            return false;
          }
        }
        return false;
      }
      function clearSession() {
        localStorage.removeItem(SESSION_STORAGE_KEY);
        deviceChecklistData = { header: "", devices: [] };
        undoStack = [];
        updateUndoButtonState();
        pdfInputEl.value = '';
        excelInputEl.value = '';
        searchInputEl.value = '';
      }

      // === SAS Panel Parsing Functions (CORE LOGIC - UNCHANGED) ===
      function extractDevicesFromSASPanelText(text) {
         let devices = [];
         const regexSerial = /(?:Device\s+)?(\d+):?\s+([\s\S]*?)\s+(\d{10})(?=\s+(?:Device\s+)?\d+|\s*$)/gi;
         let match;
         while ((match = regexSerial.exec(text)) !== null) {
           if (!devices.some(d => d.raw === match[0].trim())) {
               devices.push({ deviceNumber: match[1].trim(), description: match[2].trim(), serialNumber: match[3].trim(), raw: match[0].trim(), checked: false });
           }
         }
         const lines = text.split(/\r?\n/);
         const regexAnnunciator = /^(LCD\s+C\s+0\s+OREGON\s+LIBRARY\s+FIRE\s+PANEL\s+NORMAL)\s*(\d{1,2})$/i;
         lines.forEach(line => {
           line = line.trim(); const m = regexAnnunciator.exec(line);
           if (m && !devices.some(d => d.raw === line)) {
             devices.push({ deviceNumber: m[2].trim(), description: m[1].trim(), serialNumber: "", raw: line, checked: false });
           }
         });
         const regexNAC = /^(0?\d{1,2})\s+Genesis\s+Audible\s+Visible\s+Silence\s+B\s+NAC\s+(\d+)$/i;
         lines.forEach(line => {
           line = line.trim(); const m = regexNAC.exec(line);
           if (m && !devices.some(d => d.raw === line)) {
             devices.push({ deviceNumber: m[1].trim(), description: `Genesis Audible Visible Silence B NAC ${m[2].trim()}`, serialNumber: "", raw: line, checked: false });
           }
         });
         const regexAdditional = /^(?:Device\s*-\s*)?(\d{1,2})\s+(.+)$/i;
         lines.forEach(line => {
           line = line.trim(); if (!line) return;
           if (/\d{10}/.test(line)) return; if (/hours|minutes|Serial:|^Off$/i.test(line)) return;
           const m = regexAdditional.exec(line);
           if (m) {
             const devNum = m[1].trim(); const desc = m[2].trim(); if (/off/i.test(desc)) return;
             if (!devices.some(d => d.raw === line)) {
               devices.push({ deviceNumber: devNum, description: desc, serialNumber: "", raw: line, checked: false });
             }
           }
         });
         const noSerialDevicesCount = devices.filter(d => !d.serialNumber).length;
         if (noSerialDevicesCount < 5) {
           const finalSectionMatch = text.match(/Page:\s*\d+\s*Oregon_Library[\s\S]*$/i);
           if (finalSectionMatch) {
             const finalSectionText = finalSectionMatch[0]; const finalLines = finalSectionText.split(/\r?\n/);
             finalLines.forEach(line => {
                line = line.trim(); const mAnnun = regexAnnunciator.exec(line);
                if (mAnnun && !devices.some(d => d.description === mAnnun[1].trim())) { devices.push({ deviceNumber: mAnnun[2].trim(), description: mAnnun[1].trim(), serialNumber: "", raw: line, checked: false }); }
             });
             finalLines.forEach(line => {
                 line = line.trim(); const mNAC = regexNAC.exec(line); const nacDesc = `Genesis Audible Visible Silence B NAC ${mNAC ? mNAC[2].trim() : ''}`;
                  if (mNAC && !devices.some(d => d.description === nacDesc)) { devices.push({ deviceNumber: mNAC[1].trim(), description: nacDesc, serialNumber: "", raw: line, checked: false }); }
             });
           }
         }
         const uniqueDevicesMap = new Map();
         devices.forEach(device => { const key = device.serialNumber ? `${device.description}_${device.serialNumber}` : device.raw; if (!uniqueDevicesMap.has(key)) { uniqueDevicesMap.set(key, device); } });
         return Array.from(uniqueDevicesMap.values());
      }
      function cleanDeviceDescription(desc) {
          let cleanedDesc = desc.replace(/^Device\s+\d+:?\s*/i, '');
          const keywords = ["Smoke", "Supervisory", "Heat", "Supv", "Relay", "Pull", "Monitor", "Genesis", "Water", "Auto", "Duct", "LCD", "NAC"];
          let earliestIndex = -1;
          keywords.forEach(keyword => {
              const regex = new RegExp(`\\b${keyword}\\b`, 'i');
              const match = cleanedDesc.match(regex);
              if (match !== null) {
                  const index = match.index;
                  if (earliestIndex === -1 || index < earliestIndex) { earliestIndex = index; }
              }
          });
          if (earliestIndex !== -1) { return cleanedDesc.substring(earliestIndex).trim(); }
          return cleanedDesc.trim();
      }
      // === Default PDF Extraction Function (now named "signatureBarcodeWorksheet") ===
      function signatureBarcodeWorksheet(text) {
        text = text.replace(/Page \d+\s*of\s*\d+/gi, '');
        if (text.toLowerCase().includes("sas panel configuration") || text.toLowerCase().includes("oregon library fire panel")) {
            const devices = extractDevicesFromSASPanelText(text);
            const headerMatch = text.match(/Project:\s*(.*)\n/i) || text.match(/Location:\s*(.*)\n/i);
            const header = headerMatch ? headerMatch[1].trim() : "SAS Panel Configuration";
            return { header, devices };
        }
        const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
        let header = "";
        let devices = [];
        if (lines.length >= 3 && lines[0].startsWith("Project")) {
            header = lines[0] + " | " + lines[1] + " | " + lines[2]; lines.splice(0, 3);
        } else if (lines.length > 0 && lines[0].includes("Version :") && lines[0].includes("Device Barcode Label")) {
            header = lines[0]; lines.shift();
        }
        if (!header && lines.length > 0) { header = lines[0]; lines.splice(0, 1); }
        const serialRegex = /\b\d{3}:\d{3}:\d{4}\b/;
        let currentDeviceLines = [];
        const rawDeviceTexts = [];
        for (const line of lines) {
            currentDeviceLines.push(line);
            if (serialRegex.test(line)) {
                rawDeviceTexts.push(currentDeviceLines.join(" ")); currentDeviceLines = [];
            }
        }
        if (currentDeviceLines.length > 0) { rawDeviceTexts.push(currentDeviceLines.join(" ")); }
        devices = rawDeviceTexts
            .map(txt => txt.trim()).filter(txt => txt.length > 5)
            .map(txt => ({
                text: txt,
                deviceNumber: txt.match(/^(\d+)\b/)?.[1] || "",
                description: cleanDeviceDescription(txt.replace(/^(\d+)\b\s*/, '')),
                serialNumber: txt.match(/(\d{3}:\d{3}:\d{4})\b/)?.[1] || "",
                raw: txt, checked: false
            }));
        return { header, devices };
      }
      // === UI Display Functions ===
      function updateDeviceCount() {
        const remaining = deviceChecklistData.devices.filter(d => !d.checked).length;
        const total = deviceChecklistData.devices.length;
        deviceCountEl.textContent = `Remaining: ${remaining} / ${total}`;
      }
      function updateUndoButtonState() {
        undoLastBtnEl.disabled = (undoStack.length === 0);
      }
      function displayHeader(header) {
        headerInfoEl.textContent = header || "No project information loaded.";
      }
      function setLoadingMessage(message, isError = false) {
            loadingEl.textContent = message;
            isError ? loadingEl.classList.add('error') : loadingEl.classList.remove('error');
      }
      function displayDevices() {
        const devices = deviceChecklistData.devices;
        const searchTerm = searchInputEl.value.trim().toLowerCase();
        const fragment = document.createDocumentFragment();

        // If 'hide completed' is active, display the last completed device at the top
        if (hideCompleted) {
           let lastCompletedDevice = null;
           deviceChecklistData.devices.forEach(device => {
             if (device.checked && device.completedAt) {
               if (!lastCompletedDevice || device.completedAt > lastCompletedDevice.completedAt) {
                  lastCompletedDevice = device;
               }
             }
           });
           if (lastCompletedDevice) {
             const li = document.createElement("li");
             li.classList.add("last-completed");
             li.textContent = `Last Completed: ${lastCompletedDevice.description || lastCompletedDevice.raw}`;
             fragment.appendChild(li);
           }
        }

        const filteredDevices = devices
          .map((device, index) => ({ device, originalIndex: index }))
          .filter(({ device }) => {
            const textToSearch = (device.description + " " + (device.serialNumber || "") + " " + (device.deviceNumber || "") + " " + (device.text || "")).toLowerCase();
            const matchesSearch = !searchTerm || textToSearch.includes(searchTerm);
            // If hideCompleted is on, skip already completed devices.
            const isVisible = !(hideCompleted && device.checked);
            return matchesSearch && isVisible;
          });

        devicesOnPageEl.textContent = `(Displaying: ${filteredDevices.length})`;
        deviceListEl.innerHTML = "";

        filteredDevices.forEach(({ device, originalIndex }) => {
          const li = document.createElement("li");
          li.setAttribute("role", "listitem");

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.id = `device-${originalIndex}`;
          checkbox.checked = device.checked;
          checkbox.dataset.index = originalIndex;

          const label = document.createElement("label");
          label.htmlFor = `device-${originalIndex}`;
          
          let labelHTML = "";
          if (device.fromExcel && device.text) {
            labelHTML = device.text;
          } else if (device.description) {
            const cleanedDesc = cleanDeviceDescription(device.description || "No Description");
            labelHTML = `${cleanedDesc}`;
          } else {
            labelHTML = device.text || "Invalid device data";
          }
          label.innerHTML = labelHTML;

          checkbox.addEventListener("change", (e) => {
            const index = parseInt(e.target.dataset.index, 10);
            const currentDevice = deviceChecklistData.devices[index];
            if (!currentDevice) return;
            const oldValue = currentDevice.checked;
            const newValue = e.target.checked;
            undoStack.push({ index, oldValue, newValue });
            currentDevice.checked = newValue;
            if (newValue) {
                currentDevice.completedAt = Date.now();
            } else {
                delete currentDevice.completedAt;
            }
            saveSession();
            updateDeviceCount();
            newValue ? label.classList.add('checked') : label.classList.remove('checked');
            if (hideCompleted) displayDevices();
          });

          li.appendChild(checkbox);
          li.appendChild(label);

          li.addEventListener('click', (e) => {
             if (e.target !== checkbox && e.target !== label && !label.contains(e.target)) {
                 checkbox.checked = !checkbox.checked;
                 checkbox.dispatchEvent(new Event('change'));
             }
          });

          fragment.appendChild(li);
        });

        deviceListEl.appendChild(fragment);
        updateDeviceCount();
        updateUndoButtonState();
      }
      const debouncedDisplayDevices = debounce(displayDevices, SEARCH_DEBOUNCE_DELAY);

      // === File Parsing Functions ===
      function parsePDF(file) {
        return new Promise((resolve, reject) => {
          const fileReader = new FileReader();
          fileReader.onload = function() {
            const typedarray = new Uint8Array(this.result);
            setLoadingMessage(`Parsing PDF: ${file.name}...`);
            pdfjsLib.getDocument(typedarray).promise.then(pdf => {
              const pagePromises = Array.from({ length: pdf.numPages }, (_, i) =>
                 pdf.getPage(i + 1).then(page => page.getTextContent())
              );
              Promise.all(pagePromises).then(pageContents => {
                let fullText = pageContents.map(content => content?.items?.map(item => item?.str || '').join("\n") || '').join("\n");
                 setLoadingMessage(`Extracting devices from ${file.name}...`);
                 try {
                    const extractedData = signatureBarcodeWorksheet(fullText);
                    resolve(extractedData);
                 } catch (extractError) { reject(`Extraction failed: ${extractError.message}`); }
              }).catch(reject);
            }).catch(reject);
          };
          fileReader.onerror = () => reject(`Failed to read file: ${file.name}`);
          fileReader.readAsArrayBuffer(file);
        });
      }
      
      function parseExcel(file) {
         return new Promise((resolve, reject) => {
          const fileReader = new FileReader();
          fileReader.onload = function(e) {
            try {
              setLoadingMessage(`Parsing Excel: ${file.name}...`);
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const worksheet = workbook.Sheets[workbook.SheetNames[0]];
              const devices = [];
              let row = 7;
              while (true) {
                const cellB = worksheet["B" + row];
                if (!cellB || !cellB.v) break;
                let deviceText = "";
                ["B", "C", "D", "E", "F", "G"].forEach(col => {
                  const cell = worksheet[col + row];
                  if (cell && cell.v) {
                    deviceText += cell.v + " ";
                  }
                });
                deviceText = deviceText.trim();
                if (deviceText) {
                  const regex = /^(\d{3}:\d{3}:\d{4})\s+(.+)\s+(\d{10})$/;
                  const match = deviceText.match(regex);
                  if (match) {
                    devices.push({
                      text: match[0],
                      raw: match[0],
                      checked: false,
                      fromExcel: true
                    });
                  }
                }
                row++;
              }
              setLoadingMessage(`Extracted devices from ${file.name}...`);
              resolve({ header: `Excel Data: ${file.name}`, devices });
            } catch (excelError) { reject(`Excel parsing failed: ${excelError.message}`); }
          };
          fileReader.onerror = () => reject(`Failed to read file: ${file.name}`);
          fileReader.readAsArrayBuffer(file);
         });
      }
      
      async function handleFileUpload(files, parserFn, fileTypeDesc) {
           if (!files || files.length === 0) { alert(`Please select at least one valid ${fileTypeDesc} file.`); return; }
           pdfInputEl.disabled = true;
           excelInputEl.disabled = true;
           importFileBtnEl.disabled = true;
           setLoadingMessage(`Processing ${files.length} ${fileTypeDesc} file(s)...`);
           const parsePromises = Array.from(files).map(file =>
               parserFn(file).catch(err => ({ error: true, message: err, fileName: file.name }))
           );
           const results = await Promise.all(parsePromises);
           let newDevicesAdded = 0;
           let errorsEncountered = [];
           let firstNewHeader = "";
           setLoadingMessage("Merging data...");
           results.forEach(result => {
               if (result.error) {
                   errorsEncountered.push(`Failed: ${result.fileName} (${result.message})`);
               } else if (result?.devices) {
                    if (!firstNewHeader && result.header) firstNewHeader = result.header;
                   const currentDeviceKeys = new Set(deviceChecklistData.devices.map(d => d.raw));
                   result.devices.forEach(newDevice => {
                       const key = newDevice.raw;
                       if (!currentDeviceKeys.has(key)) {
                           newDevice.checked = newDevice.checked || false;
                           deviceChecklistData.devices.push(newDevice);
                           currentDeviceKeys.add(key);
                           newDevicesAdded++;
                       }
                   });
               }
           });
           if ((!deviceChecklistData.header || deviceChecklistData.header === "No project information loaded.") && firstNewHeader) {
                deviceChecklistData.header = firstNewHeader;
           }
           if (newDevicesAdded > 0) {
               saveSession();
               displayHeader(deviceChecklistData.header);
               displayDevices();
               setLoadingMessage(`Successfully added ${newDevicesAdded} unique devices.`);
           } else if (errorsEncountered.length === 0) {
               setLoadingMessage("No new unique devices found in the selected file(s).");
           }
           if (errorsEncountered.length > 0) {
               alert("Some files could not be processed:\n- " + errorsEncountered.join("\n- "));
               setLoadingMessage("Error processing one or more files.", true);
           }
           if (parserFn === parsePDF) pdfInputEl.value = '';
           if (parserFn === parseExcel) excelInputEl.value = '';
           pdfInputEl.disabled = false;
           excelInputEl.disabled = false;
           importFileBtnEl.disabled = false;
           setTimeout(() => { if (!loadingEl.classList.contains('error')) setLoadingMessage(""); }, 4000);
       }

      function exportListToFile() {
         if (!deviceChecklistData?.devices?.length) { alert("No device data to export."); return; }
         try {
            const dataStr = JSON.stringify(deviceChecklistData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            const filenameBase = (deviceChecklistData.header || 'device-checklist').replace(/[^a-z0-9]/gi, '_').toLowerCase();
            const dateStr = new Date().toISOString().slice(0, 10);
            link.download = `${filenameBase}_${dateStr}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
         } catch (e) { setLoadingMessage("Export failed.", true); }
      }
      fileImportInputEl.addEventListener('change', (e) => {
         const file = e.target.files[0];
         if (!file) return;
         if (!file.name.toLowerCase().endsWith('.json') || file.type !== 'application/json') {
            alert("Please select a valid .json file.");
            fileImportInputEl.value = '';
            return;
         }
         pdfInputEl.disabled = true;
         excelInputEl.disabled = true;
         importFileBtnEl.disabled = true;
         setLoadingMessage(`Importing ${file.name}...`);
         const reader = new FileReader();
         reader.onload = (evt) => {
            try {
               const importedData = JSON.parse(evt.target.result);
               if (typeof importedData !== 'object' || !importedData || !Array.isArray(importedData.devices)) {
                  throw new Error("Invalid JSON structure.");
               }
                if (!confirm(`Replace current checklist (${deviceChecklistData.devices.length} devices) with data from "${file.name}"?`)) {
                   fileImportInputEl.value = '';
                   setLoadingMessage("");
                   pdfInputEl.disabled = false;
                   excelInputEl.disabled = false;
                   importFileBtnEl.disabled = false;
                   return;
                }
               deviceChecklistData = importedData;
               deviceChecklistData.devices = deviceChecklistData.devices.map(d => ({ ...d, checked: d.checked || false }));
               undoStack = [];
               saveSession();
               displayHeader(deviceChecklistData.header);
               displayDevices();
               setLoadingMessage("Checklist imported successfully!");
            } catch (err) {
               setLoadingMessage(`Import failed: ${err.message}`, true);
            } finally {
               fileImportInputEl.value = '';
               setTimeout(() => { if (!loadingEl.classList.contains('error')) setLoadingMessage(""); }, 4000);
               pdfInputEl.disabled = false;
               excelInputEl.disabled = false;
               importFileBtnEl.disabled = false;
            }
         };
         reader.onerror = () => {
            setLoadingMessage("Failed to read the selected file.", true);
            fileImportInputEl.value = '';
            pdfInputEl.disabled = false;
            excelInputEl.disabled = false;
            importFileBtnEl.disabled = false;
         };
         reader.readAsText(file);
      });

      undoLastBtnEl.addEventListener("click", () => {
         if (undoStack.length === 0) return;
         const lastAction = undoStack.pop();
         if (deviceChecklistData.devices[lastAction.index]) {
            deviceChecklistData.devices[lastAction.index].checked = lastAction.oldValue;
            if (!lastAction.oldValue) {
                delete deviceChecklistData.devices[lastAction.index].completedAt;
            }
         }
         saveSession();
         displayDevices();

         // Increment and display the undo counter.
         undoCounter++;
         undoLastBtnEl.textContent = `Undo Last (${undoCounter})`;
         if (undoCounterTimeout) clearTimeout(undoCounterTimeout);
         undoCounterTimeout = setTimeout(() => {
             undoCounter = 0;
             undoLastBtnEl.textContent = "Undo Last";
         }, 3000);
      });

      advancedToolsBtnEl.addEventListener('click', (e) => {
         e.stopPropagation();
         const isOpen = advancedToolsDropdownEl.classList.toggle('open');
         advancedToolsBtnEl.setAttribute('aria-expanded', isOpen.toString());
         if (!isOpen) advancedToolsBtnEl.focus();
      });

      advancedToolsDropdownEl.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
              advancedToolsDropdownEl.classList.remove('open');
              advancedToolsBtnEl.setAttribute('aria-expanded', 'false');
              advancedToolsBtnEl.focus();
          }
      });

      markAllBtnEl.addEventListener("click", () => {
         const changedIndices = [];
         deviceChecklistData.devices.forEach((device, index) => {
            if (!device.checked) {
               undoStack.push({ index, oldValue: false, newValue: true });
               device.checked = true;
               device.completedAt = Date.now();
               changedIndices.push(index);
            }
         });
         if(changedIndices.length > 0) { saveSession(); displayDevices(); }
         advancedToolsDropdownEl.classList.remove('open');
         advancedToolsBtnEl.setAttribute('aria-expanded', 'false');
         advancedToolsBtnEl.focus();
      });

      clearAllBtnEl.addEventListener("click", () => {
         const changedIndices = [];
         deviceChecklistData.devices.forEach((device, index) => {
            if (device.checked) {
               undoStack.push({ index, oldValue: true, newValue: false });
               device.checked = false;
               delete device.completedAt;
               changedIndices.push(index);
            }
         });
         if(changedIndices.length > 0) { saveSession(); displayDevices(); }
         advancedToolsDropdownEl.classList.remove('open');
         advancedToolsBtnEl.setAttribute('aria-expanded', 'false');
         advancedToolsBtnEl.focus();
      });

      clearSessionBtnEl.addEventListener("click", () => {
         if (confirm(`Clear all ${deviceChecklistData.devices.length} devices and project info? This cannot be undone.`)) {
            clearSession();
            displayHeader("");
            displayDevices();
         }
         advancedToolsDropdownEl.classList.remove('open');
         advancedToolsBtnEl.setAttribute('aria-expanded', 'false');
         advancedToolsBtnEl.focus();
      });

      toggleHideCompletedEl.addEventListener("change", (e) => {
         hideCompleted = e.target.checked;
         displayDevices();
      });

      searchInputEl.addEventListener("input", debouncedDisplayDevices);

      pdfInputEl.addEventListener("change", (e) => handleFileUpload(e.target.files, parsePDF, "PDF"));
      excelInputEl.addEventListener("change", (e) => handleFileUpload(e.target.files, parseExcel, "Excel"));
      exportFileBtnEl.addEventListener("click", exportListToFile);
      importFileBtnEl.addEventListener("click", () => { fileImportInputEl.click(); });

      window.addEventListener("scroll", () => {
         requestAnimationFrame(() => {
            backToTopBtnEl.style.display = (document.documentElement.scrollTop > 400 || document.body.scrollTop > 400) ? "block" : "none";
         });
      });
      backToTopBtnEl.addEventListener("click", () => { window.scrollTo({ top: 0 }); });

      window.addEventListener('click', (e) => {
         if (!advancedToolsDropdownEl.contains(e.target) && e.target !== advancedToolsBtnEl && advancedToolsDropdownEl.classList.contains('open')) {
            advancedToolsDropdownEl.classList.remove('open');
            advancedToolsBtnEl.setAttribute('aria-expanded', 'false');
         }
      });

      if (loadSession()) {
         console.log("Session loaded.");
         displayHeader(deviceChecklistData.header);
      } else {
         console.log("No session found.");
      }
      displayDevices();

      if ('serviceWorker' in navigator) {
         window.addEventListener('load', () => {
            navigator.serviceWorker.register('./serviceworker.js')
               .then(reg => console.log('ServiceWorker registered. Scope:', reg.scope))
               .catch(err => console.error('ServiceWorker registration failed:', err));
         });
      }

    });
  </script>
</body>
</html>
